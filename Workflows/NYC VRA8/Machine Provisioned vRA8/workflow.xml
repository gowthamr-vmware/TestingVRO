<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="b619970c-5d2f-489f-8684-87b81ac1fd42" version="1.0.0" api-version="6.0.0" allowed-operations="vef" editor-version="1.6" restartMode="1" resumeFromFailedMode="0"><display-name><![CDATA[Machine Provisioned vRA8]]></display-name><description><![CDATA[This work flow acts as a master workflow for all the tasks that are to be provisioned after the VM provisioning.
1.0.3 - Fixed find VM Object function
1.0.4 - Added output properties to add to vm - ssb]]></description><position y="50.0" x="160.0"/><input><param name="scriptVariables" type="Array/CompositeType(stringToReplace:string,replacingString:string):scriptVariables"/><param name="inputProperties" type="Properties"/></input><output><param name="scriptExitCodeOut" type="number"/><param name="scriptOutputTextOut" type="string"/><param name="scriptExitCodeOut2" type="number"/><param name="scriptOutputTextOut2" type="string"/><param name="scriptExitCodeOut1" type="number"/><param name="scriptOutputTextOut1" type="string"/><param name="scriptExitCodeOut4" type="number"/><param name="scriptOutputTextOut4" type="string"/><param name="scriptExitCodeOut3" type="number"/><param name="scriptOutputTextOut3" type="string"/><param name="customProperties" type="Properties"/></output><attrib name="vmUsername" type="string" read-only="false"><value encoded="n"><![CDATA[!Admin!]]></value></attrib><attrib name="vmPassword" type="SecureString" read-only="false"><value encoded="n"><![CDATA[8BY21I6EN73M65W63W75S72P33QEEE4EE1S3977824L8D0CAAAQ4DC1B4DY40EE6C0RDC6D281S72BC86EKA36B42BQ7874C1CM8DE9273G2105FBAGCC3759QCAD718ENBE9E5CCIA7D55A2KE6AEC01U4AEE823I8EC975DJ4A3D6D1LF719E11UDC75FE7VE4316C4G3987896TF735A82O]]></value></attrib><attrib name="scriptConfigurationResource" type="ResourceElement" read-only="false"><value encoded="n"><![CDATA[dunes://service.dunes.ch/ResourceElement?id='8e2a7c7d-87cc-4ff9-b998-8ddc686f8406'&dunesName='ResourceElement']]></value></attrib><attrib name="pollingRate" type="number" read-only="false"><value encoded="n"><![CDATA[10.0]]></value><description><![CDATA[Time between all request information on the tools [seconds]]]></description></attrib><attrib name="timeout" type="number" read-only="false"><value encoded="n"><![CDATA[10.0]]></value><description><![CDATA[Timeout before throwing a timeout exception [minutes]]]></description></attrib><attrib name="scriptConfigurationResource2" type="ResourceElement" read-only="false"><value encoded="n"><![CDATA[dunes://service.dunes.ch/ResourceElement?id='69eb5d7d-6fdc-41a1-ad36-fd0743c0883b'&dunesName='ResourceElement']]></value></attrib><attrib name="scriptConfigurationResource4" type="ResourceElement" read-only="false"><value encoded="n"><![CDATA[dunes://service.dunes.ch/ResourceElement?id='79a66afe-3cc2-4244-876c-3fd8ab361c7f'&dunesName='ResourceElement']]></value></attrib><attrib name="sleepTime" type="number" read-only="false"><value encoded="n"><![CDATA[120.0]]></value><description><![CDATA[Time to sleep in seconds]]></description></attrib><attrib name="scriptExitCodeOut5" type="number" read-only="false"><value encoded="n"/></attrib><attrib name="scriptOutputTextOut5" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="sleepTimeforSymantec" type="number" read-only="false"><value encoded="n"><![CDATA[150.0]]></value><description><![CDATA[Time to sleep in seconds]]></description></attrib><attrib name="scriptConfigurationResource3" type="ResourceElement" read-only="false"><value encoded="n"><![CDATA[dunes://service.dunes.ch/ResourceElement?id='60f9ced5-6021-4e22-b5a0-f98d1b077f11'&dunesName='ResourceElement']]></value></attrib><attrib name="errorCode" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="vCenterVm" type="VC:VirtualMachine" read-only="false"><value encoded="n"/></attrib><attrib name="Role" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="machineDescription" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="machineDomain" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="roleKey" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="customProps" type="Properties" read-only="false"><value encoded="n"><![CDATA[{}]]></value></attrib><attrib name="envKey" type="string" read-only="false"><value encoded="n"/></attrib><attrib name="machineOU" type="string" read-only="false"><value encoded="n"/></attrib><workflow-item name="item0" type="end" end-mode="0"><in-binding/><position y="183.88349514563106" x="174.17475728155338"/></workflow-item><workflow-item name="item1" out-name="item24" type="task"><display-name><![CDATA[Read inputproperties]]></display-name><script encoded="false"><![CDATA[System.log("Machine Provisioned started.");
System.log("inputProperties: " + JSON.stringify(inputProperties));
var vmName = inputProperties.get('resourceNames')[0];
//vCenterVm = VcPlugin.getAllVirtualMachines(null, "xpath:matches(name, '" + vmName + "')")[0];
vCenterVm = findVM(vmName);    
customProperties = inputProperties.get('customProperties');         
machineDescription = customProperties.get('custom.machineDescription');        
roleKey = customProperties.get('custom.role');
envKey = customProperties.get('custom.environment');
machineDomain = customProperties.get('custom.machineDomain');        
machineOU = customProperties.get('custom.machineOU');  
System.log("machineDescription: " + machineDescription);
System.log("roleKey: " + roleKey);
System.log("envKey: " + envKey);
System.log("machineDomain: " + machineDomain);
System.log("machineOU: " + machineOU);
var host = VcPlugin.convertToVimManagedObject(vCenterVm, vCenterVm.runtime.host); //[VC:HostSystem]
var version = host.config.product.version;
var vc = host.sdkConnection.id;
var vCenter = host.sdkConnection.id;
var vmId = vCenterVm.id;
var outputProperties = {"vcfqdn":vc, "vmId":vmId, "vCenter":vc};

// Functions //

function findVM(vmName){
    //System.log("vmName is " + vmName)
    //var vm = VcPlugin.getAllVirtualMachines(null, "xpath:name[matches(.,'"+ vmName +"')]")[0];
    var vm = VcPlugin.getAllVirtualMachines(null, "xpath:matches(name, '" + vmName + "')")[0];
    //System.log(vm)
    if ( vm == null || vm == undefined || vm == "" ){
        System.log("Looking for the vm object...")
        var vms = VcPlugin.getAllVirtualMachines(new Array());
        for each ( v in vms ){
            if (v.name.toLowerCase() == vmName.toLowerCase() || v.name.toLowerCase() == vmName.toLowerCase()){
                System.log("Found it... " + v.name.toLowerCase() + " == " + vmName.toLowerCase())
                return v;
                }
            }
        } else {
            return vm;
        }   
}]]></script><in-binding><bind name="inputProperties" type="Properties" export-name="inputProperties"/></in-binding><out-binding><bind name="vCenterVm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="machineDescription" type="string" export-name="machineDescription"/><bind name="machineDomain" type="string" export-name="machineDomain"/><bind name="roleKey" type="string" export-name="roleKey"/><bind name="customProperties" type="Properties" export-name="customProps"/><bind name="envKey" type="string" export-name="envKey"/><bind name="machineOU" type="string" export-name="machineOU"/><bind name="outputProperties" type="Properties" export-name="customProperties"/></out-binding><position y="60.0" x="240.0"/></workflow-item><workflow-item name="item3" out-name="item26" type="task" script-module="com.vmware.library.vc.vm.tools/vim3WaitToolsStarted"><display-name><![CDATA[vim3WaitToolsStarted]]></display-name><script encoded="false"><![CDATA[//Auto generated script, cannot be modified !
System.getModule("com.vmware.library.vc.vm.tools").vim3WaitToolsStarted(vm,pollingRate,timeout) ;]]></script><in-binding><bind name="pollingRate" type="number" export-name="pollingRate"><description><![CDATA[Time between all request information on the tools [seconds]]]></description></bind><bind name="timeout" type="number" export-name="timeout"><description><![CDATA[Timeout before throwing a timeout exception [minutes]]]></description></bind><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"><description><![CDATA[VM in which the action look to get the new DNS Name]]></description></bind></in-binding><out-binding/><description><![CDATA[Wait for the VMware tools to be up and the guest running

Exception:
- Timeout: When timeout is reached
- ReferenceError: When vm is not set correctly]]></description><position y="60.0" x="460.0"/></workflow-item><workflow-item name="item8" out-name="item6" catch-name="item21" throw-bind-name="errorCode" type="link" linked-workflow-id="24c23d4c-12be-4889-aa66-29b8a450f1cd"><display-name><![CDATA[KMS Registration]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="vmUsername" type="string" export-name="vmUsername"/><bind name="vmPassword" type="SecureString" export-name="vmPassword"/><bind name="scriptConfigurationResource" type="ResourceElement" export-name="scriptConfigurationResource4"/><bind name="scriptVariables" type="Array/CompositeType(stringToReplace:string,replacingString:string):scriptVariables" export-name="scriptVariables"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut4"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut4"/></out-binding><description><![CDATA[KMS registration is done using the command "slmgr.vbs -skms 10.251.38.51 //b | slmgr.vbs -ato //b"]]></description><position y="191.77272727272725" x="1225.0"/></workflow-item><workflow-item name="item6" out-name="item7" catch-name="item22" throw-bind-name="errorCode" type="link" linked-workflow-id="BD8080808080808080808080808080806CC180800122528313869552e41805bb1"><display-name><![CDATA[Reboot guest OS]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"><description><![CDATA[Virtual machine to reboot]]></description></bind></in-binding><out-binding/><description><![CDATA[Reboots the virtual machines's guest operating system. Does not reset nonpersistent virtual machines. VMware Tools must be running.]]></description><position y="191.77272727272725" x="1025.0"/></workflow-item><workflow-item name="item7" out-name="item9" type="task" script-module="com.vmware.library.vc.vm.tools/vim3WaitToolsStarted"><display-name><![CDATA[vim3WaitToolsStarted]]></display-name><script encoded="false"><![CDATA[//Auto generated script, cannot be modified !
System.getModule("com.vmware.library.vc.vm.tools").vim3WaitToolsStarted(vm,pollingRate,timeout) ;]]></script><in-binding><bind name="pollingRate" type="number" export-name="pollingRate"><description><![CDATA[Time between all request information on the tools [seconds]]]></description></bind><bind name="timeout" type="number" export-name="timeout"><description><![CDATA[Timeout before throwing a timeout exception [minutes]]]></description></bind><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"><description><![CDATA[VM in which the action look to get the new DNS Name]]></description></bind></in-binding><out-binding/><description><![CDATA[Wait for the VMware tools to be up and the guest running

Exception:
- Timeout: When timeout is reached
- ReferenceError: When vm is not set correctly]]></description><position y="191.77272727272725" x="845.0"/></workflow-item><workflow-item name="item9" prototype-id="sleep" out-name="item19" content-mode="x" type="task"><display-name><![CDATA[Sleep]]></display-name><script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}]]></script><in-binding><bind name="sleepTime" type="number" export-name="sleepTime"><description><![CDATA[Time to sleep in seconds]]></description></bind></in-binding><out-binding/><description><![CDATA[Sleep a given number of seconds]]></description><position y="193.88349514563106" x="640.7766990291262"/></workflow-item><workflow-item name="item11" out-name="item4" catch-name="item17" throw-bind-name="errorCode" type="link" linked-workflow-id="657860d7-729c-40c7-bb4b-c98503031f61"><display-name><![CDATA[Computer Description]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="mydesc" type="string" export-name="machineDescription"/><bind name="Role" type="string" export-name="Role"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut"/></out-binding><description><![CDATA[Workflow template to use for vCAC extensibility

Input parameters can be used using vCAC VM properties using the format ExternalWFStubs.[workflow stub name].[vCO input parameter name]. If using plug-in types you need to pass their unique vCO IDs.

Input parameters was tested successfully with : 
- string
- plug-in input types
- number
- boolean]]></description><position y="55.92233009708738" x="934.757281553398"/></workflow-item><workflow-item name="item4" out-name="item5" catch-name="item18" throw-bind-name="errorCode" type="link" linked-workflow-id="720efe8b-4ed2-4ee9-9113-51c108ab9187"><display-name><![CDATA[Install Symantec]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="scriptVariables" type="Array/CompositeType(stringToReplace:string,replacingString:string):scriptVariables" export-name="scriptVariables"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut3"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut3"/></out-binding><description><![CDATA[Run a script in a guest using existing script configurations. Replaces variables in the script. Optionaly copy additional file and replace its variables as well.

If no working directory is specified:
- it is set to the guest default temp directory if there is a resource file copied
- it is set to default (c:\windows\system32 for Windows /root for Linux) if there is no resource file copied.]]></description><position y="57.96116504854369" x="1077.4757281553398"/></workflow-item><workflow-item name="item5" prototype-id="sleep" out-name="item10" content-mode="x" type="task"><display-name><![CDATA[Sleep]]></display-name><script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}]]></script><in-binding><bind name="sleepTime" type="number" export-name="sleepTimeforSymantec"><description><![CDATA[Time to sleep in seconds]]></description></bind></in-binding><out-binding/><description><![CDATA[Sleep a given number of seconds]]></description><position y="57.96116504854369" x="1217.4757281553398"/></workflow-item><workflow-item name="item10" out-name="item15" catch-name="item13" throw-bind-name="errorCode" type="link" linked-workflow-id="d7da3054-9ac3-4720-a7c3-3142c7726dbb"><display-name><![CDATA[Get disk Label]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="vmUsername" type="string" export-name="vmUsername"/><bind name="vmPassword" type="SecureString" export-name="vmPassword"/><bind name="scriptConfigurationResource" type="ResourceElement" export-name="scriptConfigurationResource3"/><bind name="customProperties" type="Properties" export-name="customProps"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut"/></out-binding><position y="60.0" x="1500.0"/></workflow-item><workflow-item name="item13" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="50.0" x="1640.0"/></workflow-item><workflow-item name="item16" out-name="item8" type="task"><display-name><![CDATA[Sleep]]></display-name><script encoded="false"><![CDATA[System.sleep(20*1000);]]></script><in-binding/><out-binding/><position y="190.0" x="1380.0"/></workflow-item><workflow-item name="item17" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="125.63106796116506" x="989.7087378640776"/></workflow-item><workflow-item name="item18" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="125.63106796116506" x="1106.2135922330096"/></workflow-item><workflow-item name="item20" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="246.66666666666663" x="1541.904761904762"/></workflow-item><workflow-item name="item21" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="245.40909090909088" x="1265.5"/></workflow-item><workflow-item name="item22" throw-bind-name="errorCode" type="end" end-mode="1"><in-binding/><position y="245.40909090909088" x="1065.5"/></workflow-item><workflow-item name="item15" out-name="item16" catch-name="item20" throw-bind-name="errorCode" type="link" linked-workflow-id="1154bf2b-1d9e-487a-bf2d-d75c6f0cf52d"><display-name><![CDATA[Domain]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="machineDomain" type="string" export-name="machineDomain"/><bind name="machineOU" type="string" export-name="machineOU"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut"/></out-binding><description><![CDATA[Workflow template to use for vCAC extensibility

Input parameters can be used using vCAC VM properties using the format ExternalWFStubs.[workflow stub name].[vCO input parameter name]. If using plug-in types you need to pass their unique vCO IDs.

Input parameters was tested successfully with : 
- string
- plug-in input types
- number
- boolean]]></description><position y="190.0" x="1500.0"/></workflow-item><workflow-item name="item19" out-name="item0" type="link" linked-workflow-id="dbfcbef0-b338-4369-8f87-579e12b741ae"><display-name><![CDATA[SCCM]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="machineDomain" type="string" export-name="machineDomain"/></in-binding><out-binding><bind name="scriptExitCodeOut" type="number" export-name="scriptExitCodeOut"/><bind name="scriptOutputTextOut" type="string" export-name="scriptOutputTextOut"/></out-binding><description><![CDATA[Workflow template to use for vCAC extensibility

Input parameters can be used using vCAC VM properties using the format ExternalWFStubs.[workflow stub name].[vCO input parameter name]. If using plug-in types you need to pass their unique vCO IDs.

Input parameters was tested successfully with : 
- string
- plug-in input types
- number
- boolean]]></description><position y="191.77272727272725" x="405.0"/></workflow-item><workflow-item name="item24" out-name="item3" type="task"><display-name><![CDATA[Get role description]]></display-name><script encoded="false"><![CDATA[var __global = System.getContext() || (function () {
    return this;
}).call(null);
var VROES = __global.__VROES || (__global.__VROES = System.getModule("com.vmware.pscoe.library.ecmascript").VROES());
var utils_1 = VROES.importLazy("com.vmware.pscoe.nyc.vra_integration.vro.actions/utils/utils");
var config = utils_1._.Utils.getConfig('NYC/CustomHostname');
var rolesProperties = config.get('roles');
Role = rolesProperties.get(roleKey);]]></script><in-binding><bind name="roleKey" type="string" export-name="roleKey"/></in-binding><out-binding><bind name="Role" type="string" export-name="Role"/></out-binding><description><![CDATA[Simple task with custom script capability.]]></description><position y="60.0" x="350.0"/></workflow-item><workflow-item name="item25" out-name="item11" throw-bind-name="errorCode" type="link" linked-workflow-id="BD808080808080808080808080808080F1C180800122528313869552e41805bb1"><display-name><![CDATA[Upgrade tools]]></display-name><in-binding><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"><description><![CDATA[Virtual machine to upgrade]]></description></bind><bind name="installerOptions" type="string" export-name=""><description><![CDATA[Command line options to pass to the installer to modify the installation procedure for VMware Tools]]></description></bind></in-binding><out-binding/><description><![CDATA[]]></description><position y="55.92233009708738" x="818.252427184466"/></workflow-item><workflow-item name="item26" out-name="item25" type="link" linked-workflow-id="e60f8012-a3a4-4edc-acdc-43b86079b9b5"><display-name><![CDATA[Apply Policy to VM]]></display-name><in-binding><bind name="roleKey" type="string" export-name="roleKey"/><bind name="vm" type="VC:VirtualMachine" export-name="vCenterVm"/><bind name="envKey" type="string" export-name="envKey"/></in-binding><out-binding/><description><![CDATA[]]></description><position y="57.96116504854369" x="639.0291262135922"/></workflow-item><presentation/></workflow>